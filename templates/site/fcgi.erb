server {
  listen   <%= listen %> ;
	server_name  <% real_server_name.each do |s_n| -%><%= s_n %> <% end -%>;
  access_log  <%= real_access_log %>;
  error_log <%= real_error_log %> <%= error_log_level %>;
  root <%= root %>;
  index <%= index %>;

<% if listen == '443' %>
  ssl on;
  ssl_certificate <%= real_ssl_certificate %>;
  ssl_certificate_key <%= real_ssl_certificate_key %>;

  ssl_session_timeout <%= ssl_session_timeout %>;

  ssl_protocols SSLv2 SSLv3 TLSv1;
  ssl_ciphers ALL:!ADH:!EXPORT56:RC4+RSA:+HIGH:+MEDIUM:+LOW:+SSLv2:+EXP;
  ssl_prefer_server_ciphers on;
<% end -%>

	## Images and static content is treated different
	location ~* ^.+.(htc|jpg|jpeg|gif|css|png|js|ico|xml)$ {
		access_log        off;
		expires           30d;
	root <%= root %>;
	}



	location / {
		index <%= index %>;
			
		<% if rewrite == true %>
				if (-f $request_filename) {
						expires max;
						break;
				}

				if ($request_filename !~ "\.(htc|jpg|jpeg|gif|css|png|js|ico)$") {
						rewrite ^(.*) /<%= index %> last;
				}
		<% end -%>
	}

	location ~ "^(.+\.php)($|/)" {
		fastcgi_index <%= index %>;

		set $script $uri;
		set $path_info "";

		if ($uri ~ "^(.+\.php)($|/)") {
			set $script $1;
		}

		if ($uri ~ "^(.+\.php)(/.+)") {
			set $script $1;
			set $path_info $2;
		}
	  
		fastcgi_pass <%= fastcgi_pass %>;

		include /etc/nginx/includes/fastcgi_params.inc;
		fastcgi_param SCRIPT_FILENAME $document_root$script;
		fastcgi_param  PATH_INFO        $path_info;
		fastcgi_param SCRIPT_NAME $script;
		<% fastcgi_params.each_pair do |param, value| -%>
			fastcgi_param <%= param %> <%= value %>;
        <% end -%>
		<% if listen == '443' %>
			fastcgi_param HTTPS on;
		<% end -%>
	}

  ## Disable viewing .htaccess & .htpassword
	location ~ /\.ht {
    deny all;
  }

<% if include != '' -%>
<% include.each do |inc| -%>
  include <%= inc %>;
<% end -%>
<% end -%>
}
